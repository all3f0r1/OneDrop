# OneDrop v0.5.0 Roadmap - Per-Pixel Shader Execution

Detailed roadmap for implementing per-pixel shader execution in OneDrop.

## Overview

v0.5.0 will add support for executing per-pixel equations from Milkdrop presets, enabling full compatibility with complex visual effects.

## Current State (v0.4.0)

✅ **Implemented**:
- Parser for per-pixel equations
- Expression evaluator
- GPU rendering pipeline
- 27 blending patterns
- Double-preset support

❌ **Not Implemented**:
- Per-pixel equation execution on GPU
- HLSL to WGSL translation
- Custom shader compilation
- Per-pixel variable access

## Goals for v0.5.0

1. **Per-Pixel Shader Execution** - Execute equations for each pixel
2. **HLSL to WGSL Translation** - Convert legacy shaders
3. **Dynamic Shader Compilation** - Compile shaders at runtime
4. **Full Preset Compatibility** - Support 95%+ of presets

## Architecture

### Current Flow

```
Preset → Parser → Evaluator → Renderer
                     ↓
              Per-frame only
```

### v0.5.0 Flow

```
Preset → Parser → Shader Generator → GPU Compiler → Renderer
                        ↓
                  Per-pixel shaders
```

## Implementation Plan

### Phase 1: Shader Generator (Week 1-2)

**Goal**: Generate WGSL shaders from per-pixel equations

**Tasks**:
1. Create `onedrop-codegen` crate
2. Implement expression to WGSL transpiler
3. Handle variable mapping
4. Generate shader entry points

**Example**:

```rust
// Input: per_pixel_1=x = x + 0.01*sin(time);
// Output WGSL:
@fragment
fn per_pixel_main(input: PixelInput) -> @location(0) vec4<f32> {
    var x = input.uv.x;
    x = x + 0.01 * sin(uniforms.time);
    return vec4<f32>(x, input.uv.y, 0.0, 1.0);
}
```

### Phase 2: HLSL Translation (Week 3-4)

**Goal**: Translate HLSL warp/comp shaders to WGSL

**Tasks**:
1. Parse HLSL syntax
2. Map HLSL functions to WGSL
3. Convert texture sampling
4. Handle shader model differences

**Mapping Table**:

| HLSL | WGSL |
|------|------|
| `tex2D(sampler, uv)` | `textureSample(texture, sampler, uv)` |
| `float4` | `vec4<f32>` |
| `mul(matrix, vector)` | `matrix * vector` |
| `lerp(a, b, t)` | `mix(a, b, t)` |
| `saturate(x)` | `clamp(x, 0.0, 1.0)` |

### Phase 3: Dynamic Compilation (Week 5-6)

**Goal**: Compile shaders at runtime

**Tasks**:
1. Integrate `naga` for shader validation
2. Create shader cache system
3. Handle compilation errors gracefully
4. Optimize shader performance

**Flow**:

```
Equations → WGSL → naga → SPIR-V → wgpu → GPU
             ↓
          Cache
```

### Phase 4: Variable System (Week 7-8)

**Goal**: Full per-pixel variable access

**Tasks**:
1. Implement variable buffer system
2. Map Milkdrop variables to WGSL
3. Handle q1-q64 variables
4. Support custom variables

**Variables**:

```wgsl
struct PixelVars {
    // Coordinates
    x: f32,
    y: f32,
    rad: f32,
    ang: f32,
    
    // Audio
    bass: f32,
    mid: f32,
    treb: f32,
    
    // Time
    time: f32,
    frame: f32,
    
    // Custom
    q: array<f32, 64>,
}
```

### Phase 5: Testing & Optimization (Week 9-10)

**Goal**: Ensure stability and performance

**Tasks**:
1. Test with 1000+ presets
2. Profile shader performance
3. Optimize hot paths
4. Fix edge cases

## Technical Challenges

### Challenge 1: Expression Complexity

**Problem**: Some equations are very complex

**Solution**: 
- Break into multiple passes
- Use compute shaders for heavy math
- Cache intermediate results

### Challenge 2: HLSL Compatibility

**Problem**: HLSL and WGSL have different semantics

**Solution**:
- Create compatibility layer
- Emulate missing functions
- Document unsupported features

### Challenge 3: Performance

**Problem**: Per-pixel execution is expensive

**Solution**:
- Use GPU compute shaders
- Batch operations
- Optimize shader code

### Challenge 4: Error Handling

**Problem**: Invalid equations crash renderer

**Solution**:
- Validate before compilation
- Fallback to safe defaults
- Show user-friendly errors

## New Crates

### onedrop-codegen

**Purpose**: Generate WGSL shaders from equations

**Modules**:
- `transpiler` - Expression to WGSL
- `optimizer` - Shader optimization
- `validator` - Syntax validation

**API**:

```rust
use onedrop_codegen::ShaderGenerator;

let generator = ShaderGenerator::new();
let wgsl = generator.generate_per_pixel_shader(&equations)?;
```

### onedrop-hlsl

**Purpose**: HLSL to WGSL translation

**Modules**:
- `parser` - HLSL parsing
- `translator` - HLSL to WGSL
- `compat` - Compatibility layer

**API**:

```rust
use onedrop_hlsl::translate_shader;

let hlsl = "float4 PS(...) { ... }";
let wgsl = translate_shader(hlsl)?;
```

## Performance Targets

| Metric | Target |
|--------|--------|
| Shader compilation | < 100ms |
| Per-pixel overhead | < 1ms |
| Memory usage | < 50MB |
| FPS (1080p) | 60 FPS |

## Compatibility Goals

| Preset Type | Target |
|-------------|--------|
| Basic presets | 100% |
| Per-pixel presets | 95% |
| Custom shaders | 80% |
| HLSL shaders | 70% |

## API Changes

### New Methods

```rust
impl MilkEngine {
    /// Enable per-pixel shader execution
    pub fn enable_per_pixel(&mut self, enable: bool);
    
    /// Set shader quality level
    pub fn set_shader_quality(&mut self, quality: ShaderQuality);
    
    /// Get shader compilation status
    pub fn shader_status(&self) -> ShaderStatus;
}
```

### New Types

```rust
pub enum ShaderQuality {
    Low,      // Simplified shaders
    Medium,   // Standard shaders
    High,     // Full quality
    Ultra,    // Maximum quality
}

pub enum ShaderStatus {
    Compiling,
    Ready,
    Error(String),
}
```

## Testing Strategy

### Unit Tests

```rust
#[test]
fn test_expression_to_wgsl() {
    let expr = "x = x + 0.01*sin(time)";
    let wgsl = transpile_expression(expr).unwrap();
    assert!(wgsl.contains("sin(uniforms.time)"));
}
```

### Integration Tests

```rust
#[test]
fn test_per_pixel_rendering() {
    let preset = load_preset("test_per_pixel.milk");
    let engine = MilkEngine::new(800, 600)?;
    engine.enable_per_pixel(true);
    engine.load_preset(preset)?;
    
    let texture = engine.render()?;
    assert_valid_texture(texture);
}
```

### Compatibility Tests

```rust
#[test]
fn test_preset_compatibility() {
    let presets = load_all_presets("test-presets-200");
    let mut success = 0;
    
    for preset in presets {
        if engine.load_preset(preset).is_ok() {
            success += 1;
        }
    }
    
    let rate = success as f32 / presets.len() as f32;
    assert!(rate >= 0.95, "Compatibility rate: {:.1}%", rate * 100.0);
}
```

## Documentation

### New Guides

1. **Per-Pixel Shader Guide** - How to write per-pixel equations
2. **HLSL Migration Guide** - Converting HLSL to WGSL
3. **Performance Tuning** - Optimizing shader performance
4. **Troubleshooting** - Common issues and solutions

### API Documentation

All new APIs will be fully documented with:
- Description
- Examples
- Performance notes
- Compatibility notes

## Migration Path

### From v0.4.0 to v0.5.0

**Breaking Changes**: None (backward compatible)

**New Features**:
```rust
// Enable per-pixel shaders (opt-in)
engine.enable_per_pixel(true);

// Existing code continues to work
engine.load_preset(preset)?;
engine.render()?;
```

## Success Criteria

✅ v0.5.0 is successful if:

1. **95%+ preset compatibility** - Most presets work
2. **60 FPS at 1080p** - Performance maintained
3. **< 100ms compilation** - Fast shader generation
4. **No regressions** - v0.4.0 features still work
5. **Clean API** - Easy to use and understand

## Timeline

| Week | Phase | Deliverable |
|------|-------|-------------|
| 1-2 | Shader Generator | `onedrop-codegen` crate |
| 3-4 | HLSL Translation | `onedrop-hlsl` crate |
| 5-6 | Dynamic Compilation | Runtime shader system |
| 7-8 | Variable System | Full variable support |
| 9-10 | Testing | 95%+ compatibility |

**Total**: 10 weeks (~2.5 months)

## Post-v0.5.0

### v0.6.0 (Planned)
- Shader editor
- Visual preset creator
- Real-time shader preview

### v1.0.0 (Goal)
- Production stability
- Complete documentation
- Community features

## Resources

- [WGSL Specification](https://www.w3.org/TR/WGSL/)
- [naga Documentation](https://docs.rs/naga/)
- [Milkdrop Preset Authoring](https://www.geisswerks.com/milkdrop/)
- [wgpu Examples](https://github.com/gfx-rs/wgpu)

## License

MIT - See LICENSE file for details

---

*OneDrop v0.5.0 - Roadmap for Per-Pixel Shader Execution*
